\nomenclature[]{UE4}{Unreal Engine 4}
\nomenclature[]{RAV}{Robotic Aerial Vehicle}
\note{It might make sense to move some of this to the lit. review}

\subsubsection{Evaluation Criteria}
In order to design the virtual environment, it was important to first identify the criteria that would determine its usefulness. We began with identifying key phenomena that would need to be present, or integrated in future iterations. This was based on an operational scenario that was outlined in the ROCSAFE project specification\cite{rocsafeNUIG}. Numerous operational scenarios are described that represent distinct classes of CBRNe threat; we picked the one that would be most easily modified for general-purpose use.
\note{Not sure how deeply I can discuss rail environment due to potential dissemination level issues. @Michael will need to approve this. Assuming since most of this work is freely available as an executable, it's ok to describe it here.}
%Would be good to expand this description if possible.
A brief description of the scene is as follows. The scene is set in a rural location, with some forest, a twin track rail line, a small town 10Km away with a small road running near to the rail tracks with access to the rail tracks. The conditions are cool and dry, with a light breeze. A train has been derailed and heavy machinery has been used to damage the tracks. Radioactive material in containers has been exposed. It is intended to use autonomous aerial and ground vehicles to remotely survey and document the scene. They will then be used to localize forensic evidence, subsequently leading to remote evidence collection. The result of modelling this scenario using UE4 is shown in figures x - y.%add figures here.

%Should talk about the rad. environment here but not sure of dissemination status.
The core components that the simulation of this scenario requires were identified: 
\note{This is probably the most important part of this chapter}
\begin{itemize}
    \item The ability to place arbitrary realistic virtual representations of physical objects in the scenario in various configurations
    \item The ability to render high-quality images from the scenario from arbitrary locations at arbitrary resolutions.
    \item Multiple heterogeneous simulated aerial vehicles, with a high-level API for sensing and navigation for each vehicle. The API should not be platform-specific so that different types of vehicle may be considered.
    \item Simulated sensor readings from the aerial vehicles, including position, velocity, altitude, that depend on the state of the aerial vehicle in the environment. For example, if the aerial vehicle is close to a source of radiation, the simulated sensor reading should be high.
    \item Simulation software should have a permissive licence and should permit publications that include details of the software.
    \item The ability to run the simulations at an increased speed without corrupting the fidelity of the sensor/actuator functionality.
\end{itemize}
\note{More can be added to this list.}

\subsubsection{Pre-existing tools and softwares}
In order to provide this functionality, it is clear that using existing tools would be desirable, as writing the boiler plate code necessary to implement such complexity would be extensive. Game engines have been increasingly used for simulations of physical phenomena, with a growing interest in niche areas. Examples include generating high-fidelity training data for computer vision algorithms, \cite{QiuUnrealCV:Engine}, deep learning algorithms \cite{GaidonVirtualAnalysis}, automated crowd size estimation algorithms \cite{Lee2018DigitalCrowds} and target tracking algorithms \cite{Mueller2016ATracking}. An overview of game engines and their use in creating simulation software is outlined in section \ref{GameEngineReview}. The overview describes how most modern simulation softwares that use game engine components are mature in their capabilities to model and render physical scenarios, but not all provide good support for the use of robotic vehicles.
\note{want to get across that basic rendering etc. is offered by many platforms, real issue is to find something to work with that can provide support for Remotely Operated Vehicles / Autonomous vehicles}
This meant that an emphasis was placed on choosing software with some capability to implement high-fidelity simulated aerial vehicles as well as basic physics and graphics rendering.
%Specific functionality can commonly be added to games engines using plugins, which are usually specific to an individual games engine. 
Standalone simulation tools were considered alongside tools built on top of game engines. The simulation softwares whose potential use for designing a custom simulation environment for disaster scene management that were investigated are show in table \ref{table:SimulatorComparison}, with more detailed overviews provided in \cite{Ebeid2018ASimulators}.
\note{Might be better off presenting this as a table.
Format could be Simulator | Licence | Implementation Language | Supported OS | Developer | Additional Notes}
%\begin{itemize}
%Provide a brief description of each.
%    \item Gazebo: A free, open-source standalone simulator written in C++. Development began at the University of Southern California, now maintained by the Open Source Robotics Foundation. \cite{Koenig2005DesignSimulator}
%    \item Airsim: A free, open-source C++ plugin for UE4 developed by Microsoft AI \& Research. MIT Licence. \cite{Shah2017AirSim:Vehicles}
%    \item jMAVSim: A free, open-
%    \item HackFlightSim
%    \item RotorS
%    \item Morse
%    \item New Paparazzi Simulator
%\end{itemize}

\begin{center}
\begin{table}
\footnotesize
\centering
\begin{tabular}{ p{2.1cm} p{2.2cm} p{2.1cm} p{2.1cm} p{2.1cm} p{2.1cm}} 
\hline
Simulator & Implementation Language & Supported OS & Licence & Developer & High-Level Dependencies\\
\hline
Gazebo \cite{Koenig2005DesignSimulator} & C++ & Linux, MacOS & Apache V2.0 & Open Source Robotics Foundation & \\
\\
AirSim \cite{Shah2017AirSim:Vehicles} & C++ & Windows, Linux & MIT & Microsoft & Unreal Engine 4\\ 
\\
jMAVSim \cite{jMAVSim} & Java & Linux, MacOS, Windows & BSD 3 & DroneCode Project & Java3D\\
\\
HackFlightSim (renamed MulticoptorSim) \cite{MulticopterSim} & C++ & Linux, Windows & GPL & SimondLevy & Unreal Engine 4 \\
\\
RotorS & C++ & Ubuntu & ASL 2.0 & ETH Zurich & ROS, Gazebo\\
\\
Morse & Python & Linux & BSD & LAAS-CNRS & Blender Game Engine \\
\\
New Paparazzi Simulator & C & Linux, MacOS & GPL v2 & Ecole Nationale de lâ€™ Aviation Civil & JSBSim\\
\hline
\end{tabular}
\caption{Simulator Comparisons}
\label{table:SimulatorComparison}
\end{table}
\end{center}

UE4 with the Airsim plugin was chosen to develop the simulation since the documentation for both suggested that it was most suitable in relation to the design requirements/evaluation criteria outlined above.\par

\subsubsection{Unreal Engine Design Process}
\note{might need to re-word this. This section should be about the design process that was used once Unreal Engine had be determined the platform of choice to develop with}
The design process of any simulation or game using UE4 should follow certain good practices in order to avoid some common pitfalls that can cause serious delays in development. Once a level has been built using UE4, it can be labor-intensive to radically alter it\cite[p.~454]{Rouse2005GamePractice}. This suggests that care should be taken to ensure to plan the design process so that consistent and efficient results can be achieved.

Unfortunately, most material related to design of simulations and games using UE4 are highly qualitative, addressing questions like "what does the player actually want and how can that be delivered?" rather than describing how the process should proceed. Some good level design practices are noted in \cite{Rouse2005GamePractice}, although many are not applicable to the design of a serious simulation. Notable points include:
\begin{enumerate}
    \item Pencil and paper sketches of the level's general layout can be a very good idea in order to avoid the perils of "designing yourself into a corner". As an example, this could manifest itself as underestimating the proximity between two high-level objects (e.g. a hall and a room) which may lead to a large-scale redesign further down the design process.
    \item During the first pass, do not worry overly about textures and geometry, focus on ensuring that the layout is realistic.
    \item Refine the architecture once a realistic layout has been identified
    \item Add basic gameplay once the physical layout has taken shape. This avoids a tight coupling between the two.
    \item The final step will be to refine gameplay and aesthetics.
\end{enumerate}

Using these concepts as a basis, the design process for the simulation environment proceeded roughly as follows, bearing in mind the evaluation criteria identified at the start of the chapter:
\begin{enumerate}
    \item A sketch of the layout was drawn up based on an operational scenario outlined in the ROCSAFE project proposal \cite{rocsafeNUIG}, which is outlined in section x.
    \item The landscape was sculpted and painted using UE4 in-built landscaping tools.
    \item We identified the assets that would be necessary to develop the environment to our specification. These assets were acquired from websites such as 
\href{http://www.cgtrader.com}{CGTrader}\footnote{\href {http://www.cgtrader.com}{https://www.cgtrader.com}}
and 
\href{https://3dwarehouse.sketchup.com/?hl=en}{Google 3D warehouse}\footnote{\href {https://3dwarehouse.sketchup.com/?hl=en}{https://www.3dwarehouse.sketchup.com}}.
\item The assets were imported into \emph{Autodesk 3DS} in order to ensure that textures were of sufficient quality to facilitate the planned image processing on collected images.
\item They were then imported into UE4 as static meshes and placed into the scene according to the sketch. In order to ensure that this process can scale, we ensured that static meshes could be replaced by simply importing a new mesh which retains the position of the original in the environment. 
\item Rendered images were qualitatively evaluated to determine their suitablility.
\item The environment was archived before integrating "gameplay" and dynamics.
\item The Airsim \cite{Shah2017AirSim:Vehicles} plugin was integrated. This step is non-trivial and details of how this was done is outlined in the next section.
\end{enumerate} 
\note{Would be good to discuss some of the challenges met while developing the simulation and how they were overcome}
\subsubsection{Results Without Dynamic Elements}
This process was carried out iteratively and the results of the developed world excluding the dynamic elements are discussed here. 
\begin{figure}
    \centering
    \includegraphics{Chapters/SimulationEnv/Figs/RailScenarioFirstIteration.png}
    \caption{First Iteration of Environment Design}
    \label{fig:firstIterationVEnv}
\end{figure}

%Talk about how well static world matches specification, how well rendered images perform for training some object detection etc.
%Also talk about how the environment was packaged and open-sourced with permissive licence for general use
